name: TerraformTflintComponentLinux
description: Installs Terraform and TFLint on Linux
schemaVersion: 1.0

parameters:
  - name: TerraformVersion
    type: string
    description: Version of Terraform to install (e.g., latest or a specific version like 1.5.0)
    default: "1.5.0"
  - name: TflintVersion
    type: string
    description: Version of TFLint to install (e.g., latest or a specific version like v0.47.0)
    default: "v0.47.0"

phases:
  - name: build
    steps:
      - name: InstallTerraformTflint
        action: ExecuteBash
        inputs:
          commands:
            - |
              # Detect the base OS
              if [ -f /etc/os-release ]; then
                . /etc/os-release
                OS_ID=$ID
                OS_VERSION=$VERSION_ID
              else
                echo "Cannot detect OS type. Exiting."
                exit 1
              fi
              
              # Install Terraform and TFLint based on OS type
              if [ "$OS_ID" = "amzn" ]; then
                echo "Detected Amazon Linux $OS_VERSION"
                sudo dnf update -y
                sudo dnf install -y unzip wget
                # Install Terraform
                wget https://releases.hashicorp.com/terraform/{{.TerraformVersion}}/terraform_{{.TerraformVersion}}_linux_amd64.zip -O /tmp/terraform.zip
                unzip /tmp/terraform.zip -d /usr/local/bin/
                rm -f /tmp/terraform.zip
                # Install TFLint
                wget https://github.com/terraform-linters/tflint/releases/download/{{.TflintVersion}}/tflint_linux_amd64.zip -O /tmp/tflint.zip
                unzip /tmp/tflint.zip -d /usr/local/bin/
                rm -f /tmp/tflint.zip
              elif [ "$OS_ID" = "ubuntu" ]; then
                echo "Detected Ubuntu $OS_VERSION"
                sudo apt update -y
                sudo apt install -y unzip wget
                # Install Terraform
                wget https://releases.hashicorp.com/terraform/{{.TerraformVersion}}/terraform_{{.TerraformVersion}}_linux_amd64.zip -O /tmp/terraform.zip
                unzip /tmp/terraform.zip -d /usr/local/bin/
                rm -f /tmp/terraform.zip
                # Install TFLint
                wget https://github.com/terraform-linters/tflint/releases/download/{{.TflintVersion}}/tflint_linux_amd64.zip -O /tmp/tflint.zip
                unzip /tmp/tflint.zip -d /usr/local/bin/
                rm -f /tmp/tflint.zip
              else
                echo "Unsupported OS: $OS_ID"
                exit 1
              fi
              
              # Verify installations
              terraform --version
              tflint --version 