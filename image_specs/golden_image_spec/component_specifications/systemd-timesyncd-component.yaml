name: SystemdTimesyncdComponentLinux
description: Configures systemd-timesyncd for NTP on Linux
schemaVersion: 1.0

parameters:
  - name: NtpServers
    type: string
    description: NTP servers to configure in systemd-timesyncd (space-separated)
    default: "0.pool.ntp.org 1.pool.ntp.org 2.pool.ntp.org 3.pool.ntp.org"

phases:
  - name: build
    steps:
      - name: ConfigureSystemdTimesyncd
        action: ExecuteBash
        inputs:
          commands:
            - |
              # Detect the base OS
              if [ -f /etc/os-release ]; then
                . /etc/os-release
                OS_ID=$ID
                OS_VERSION=$VERSION_ID
              else
                echo "Cannot detect OS type. Exiting."
                exit 1
              fi

              # Configure systemd-timesyncd based on OS type
              if [ "$OS_ID" = "amzn" ] || [ "$OS_ID" = "ubuntu" ]; then
                echo "Detected $PRETTY_NAME"
                # Ensure systemd-timesyncd is installed
                if [ "$OS_ID" = "amzn" ]; then
                  sudo dnf update -y
                  sudo dnf install -y systemd
                elif [ "$OS_ID" = "ubuntu" ]; then
                  sudo apt update -y
                  sudo apt install -y systemd-timesyncd
                fi
                # Configure NTP servers
                sudo bash -c "cat > /etc/systemd/timesyncd.conf << EOF
[Time]
NTP={{.NtpServers}}
EOF"
                # Enable and start systemd-timesyncd
                sudo systemctl enable systemd-timesyncd
                sudo systemctl start systemd-timesyncd
                # Verify configuration
                timedatectl
              else
                echo "Unsupported OS: $OS_ID"
                exit 1
              fi
