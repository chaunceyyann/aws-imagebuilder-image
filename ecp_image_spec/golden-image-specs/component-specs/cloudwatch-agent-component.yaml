name: CloudWatchAgentComponentLinux
description: Installs and configures AWS CloudWatch Agent on Linux
schemaVersion: 1.0

parameters:
  - name: ConfigS3Path
    type: string
    description: S3 path for CloudWatch Agent configuration file
    default: "s3://your-bucket/cloudwatch-agent-config.json"

phases:
  - name: build
    steps:
      - name: InstallCloudWatchAgent
        action: ExecuteBash
        inputs:
          commands:
            - |
              # Detect the base OS
              if [ -f /etc/os-release ]; then
                . /etc/os-release
                OS_ID=$ID
                OS_VERSION=$VERSION_ID
              else
                echo "Cannot detect OS type. Exiting."
                exit 1
              fi
              
              # Install CloudWatch Agent based on OS type
              if [ "$OS_ID" = "amzn" ]; then
                echo "Detected Amazon Linux $OS_VERSION"
                sudo dnf update -y
                sudo dnf install -y amazon-cloudwatch-agent
              elif [ "$OS_ID" = "ubuntu" ]; then
                echo "Detected Ubuntu $OS_VERSION"
                sudo apt update -y
                # Download and install CloudWatch Agent for Ubuntu
                wget https://s3.amazonaws.com/amazoncloudwatch-agent/ubuntu/amd64/latest/amazon-cloudwatch-agent.deb -O /tmp/amazon-cloudwatch-agent.deb
                sudo dpkg -i -E /tmp/amazon-cloudwatch-agent.deb
                rm -f /tmp/amazon-cloudwatch-agent.deb
              else
                echo "Unsupported OS: $OS_ID"
                exit 1
              fi
              
              # Optionally download a config file from S3
              aws s3 cp {{.ConfigS3Path}} /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json
              # Start the CloudWatch Agent
              sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s
              sudo systemctl enable amazon-cloudwatch-agent
              sudo systemctl start amazon-cloudwatch-agent 